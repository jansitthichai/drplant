import os
from google import genai
from google.genai import types
from PIL import Image

def analyze_image(image_file):
    """
    Analyzes an image using Google Gemini 2.0 Flash (via google.genai SDK).
    
    Args:
        image_file (BytesIO): The image data in memory.
        
    Returns:
        str: The text response from Gemini.
    """
    
    api_key = os.getenv('GEMINI_API_KEY')
    if not api_key:
        return "Error: GEMINI_API_KEY not found."

    # Instantiate the client
    client = genai.Client(api_key=api_key)
    
    # Load image from BytesIO
    try:
        image_data = Image.open(image_file)
    except Exception as e:
        return f"Error opening image: {e}"

    # System Prompt
    system_prompt = """
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏´‡∏°‡∏≠‡∏û‡∏∑‡∏ä‡∏≠‡∏µ‡∏™‡∏≤‡∏ô" ‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡πá‡∏î‡∏£‡∏≤
    ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å: ‡πÉ‡∏à‡∏î‡∏µ, ‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ß‡πâ‡∏≤‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏°‡πà‡∏ß‡∏ô‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á), ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á
    
    ‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
    - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö" ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß "‡∏ö‡πà‡∏≤‡∏ß‡∏´‡∏°‡∏≠‡∏û‡∏∑‡∏ä..." ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
    - ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ "‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ" ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    - **‡∏´‡πâ‡∏≤‡∏°** ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏≠‡∏∏‡∏ó‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ö‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡πÇ‡∏≠‡∏¢", "‡πÄ‡∏≠‡πâ‡∏≠", "‡πÇ‡∏≠‡πâ‡∏¢", "‡∏Æ‡πà‡∏ß‡∏¢", "‡∏õ‡πâ‡∏≤‡∏î" ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• ‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡∏ü‡∏±‡∏á

    ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
    1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡∏ä/‡∏ú‡∏±‡∏Å: 
       - ‡∏ö‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢/‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô) **‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å**
       - ‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≤‡∏á‡∏¢‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£
       - **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°:** (‡∏ö‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏≤‡∏ö, ‡∏ã‡∏∏‡∏ö‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å)
    2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡πá‡∏î:
       - ‡∏ö‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£/‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô) **‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å**
       - **‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà:** (‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤ "‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏°‡∏µ‡∏û‡∏¥‡∏©/‡∏Å‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")
       - ‡∏ñ‡πâ‡∏≤‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡πá‡∏î‡πÜ ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡∏™‡∏≤‡∏ô
       - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏©: ‡∏ö‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ó‡∏£‡∏≤‡∏ö)
    3. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä: ‡∏£‡∏∞‡∏ö‡∏∏ **[‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ] ‡πÉ‡∏ô/‡∏ö‡∏ô [‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä]** (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÉ‡∏ö‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤, ‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏´‡∏á‡∏¥‡∏Å‡πÉ‡∏ô‡∏û‡∏£‡∏¥‡∏Å) **‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å**, ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏, ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå
    4. ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏û‡∏∑‡∏ä: ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏ß‡πà‡∏≤ "[‡∏≠‡∏¥‡∏´‡∏¢‡∏±‡∏á‡∏´‡∏ô‡∏¥]" ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ï‡∏•‡∏Å‡πÜ

    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "‡∏ô‡∏¥‡∏¢‡∏°‡∏Å‡∏¥‡∏ô‡∏Å‡∏±‡∏ö" ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà" ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡πá‡∏î):
    [‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä/‡πÄ‡∏´‡πá‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ]
    -----------------------
    (‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏°‡∏≠‡∏û‡∏∑‡∏ä‡∏≠‡∏µ‡∏™‡∏≤‡∏ô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢)
    
    ‡∏ô‡∏¥‡∏¢‡∏°‡∏Å‡∏¥‡∏ô‡∏Å‡∏±‡∏ö / ‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà:
    (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)
    -----------------------
    (‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ/‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
    ...
    -----------------------
    üéµ ‡∏ú‡∏ç‡∏≤‡∏û‡∏≤‡πÄ‡∏û‡∏•‡∏¥‡∏ô: (‡πÅ‡∏ï‡πà‡∏á‡∏ú‡∏ç‡∏≤‡∏≠‡∏µ‡∏™‡∏≤‡∏ô 1 ‡∏ö‡∏ó ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô)
    """

    try:
        # Generate content using the new SDK
        response = client.models.generate_content(
            model='gemini-2.0-flash',
            contents=[system_prompt, image_data]
        )
        return response.text
    except Exception as e:
        error_str = str(e)
        if "429" in error_str or "ResourceExhausted" in error_str:
            return "Error: 429 Resource Exhausted"
        elif "404" in error_str or "NotFound" in error_str:
            return "Error: 404 Model Not Found"
        else:
            return f"Error: Other {error_str}"
